<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Tempus</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="/css2/demo.css" />
    <style>
      .custom-thead th {
        background-color: #212529 !important;
        color: #fff !important;
        .table td,
        .table th {
          padding-top: 2rem !important;
          padding-bottom: 2rem !important;
          vertical-align: middle; /* keeps content centered */
        }
      }
    </style>
  </head>
  <body class="bg-light">
    <!--topBar-->
    <%- include('../../views/partials/admin/topBar')%>
    <!--topBar-->

    <!-- Main Content -->
    <div class="main-content">
      <!--sideBar-->
      <%- include('../../views/partials/admin/sideBar')%>
      <!--sideBar-->

      <!-- ALERT: Show if any return/cancel request exists -->
      <% let hasRequests = orders.some(order =>
      order.orderDetails.return?.returnStatus === 'requested' ||
      order.orderDetails.orderItems.some(prod => prod.return?.returnStatus ===
      'requested' ) ); %>

      <% if (hasRequests) { %>
      <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <strong>⚠ Attention Admin!</strong> Some orders have
        <span class="badge bg-warning text-dark">Return Requests</span>. Please
        review them below.
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
        ></button>
      </div>
      <% } %>

      <!-- Dashboard Content -->
      <main class="container-fluid py-4">
        <!-- Search & Filters -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <form action="/admin/orders" method="get" class="d-flex">
            <div class="input-group">
              <input
                type="text"
                class="form-control"
                name="search"
                placeholder="Search by Order Number, User Email, or Name"
                style="border-radius: 5px; width: 360px"
              />
              <button
                class="btn btn-white btn-outline-dark mx-3"
                type="submit"
                style="border-radius: 5px"
              >
                Search
              </button>
              <button
                class="btn btn-white mx-1"
                type="clear"
                style="border-radius: 5px; border-color: #212529"
              >
                <a href="/admin/orders" class="text-decoration-none text-dark"
                  >Clear</a
                >
              </button>
            </div>
          </form>
          <div class="d-flex">
            <div class="dropdown dropdown-menu-end me-3">
              <button
                type="button"
                class="btn btn-white btn-outline-dark dropdown-toggle"
                data-bs-toggle="dropdown"
              >
                Filter by status
              </button>
              <ul class="dropdown-menu">
                <li>
                  <a class="dropdown-item" onclick="setStatus('all')">All</a>
                </li>
                <li>
                  <a class="dropdown-item" onclick="setStatus('pending')"
                    >Pending</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" onclick="setStatus('confirmed')"
                    >Confirmed</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" onclick="setStatus('shipped')"
                    >Shipped</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" onclick="setStatus('delivered')"
                    >Delivered</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" onclick="setStatus('cancelled')"
                    >Cancelled</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" onclick="setStatus('returned')"
                    >Returned</a
                  >
                </li>
              </ul>
            </div>

            <div class="dropdown dropdown-menu-end">
              <button
                type="button"
                class="btn btn-white btn-outline-dark dropdown-toggle"
                data-bs-toggle="dropdown"
              >
                Sort by
              </button>
              <ul class="dropdown-menu">
                <li>
                  <a class="dropdown-item" onclick="setSort('date_desc')"
                    >Newest First</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" onclick="setSort('date_asc')"
                    >Oldest First</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" onclick="setSort('amount_desc')"
                    >Amount High → Low</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" onclick="setSort('amount_asc')"
                    >Amount Low → High</a
                  >
                </li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Users Table -->
        <div class="container mt-4">
          <div class="card shadow-sm">
            <div class="card-header">
              <h5 class="card-title mb-0">Orders</h5>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <%if(orders){%>

                <table
                  class="table table-bordered table-hover align-middle text-center"
                >
                  <thead class="custom-thead">
                    <tr>
                      <th>Order Number</th>
                      <th>Date</th>
                      <th>Customer Name</th>
                      <th>Items × Quantity</th>
                      <th>Order Total</th>
                      <th>Payment Method - Status</th>
                      <th>Order Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% orders.forEach((item) => { %>
                    <tr>
                      <td>
                        <%=item.orderDetails.orderNumber%>

                        <%  if(item.orderDetails.return?.returnStatus === 'requested') { %>
                        <span class="badge bg-warning text-dark ms-1"
                          >Return Requested</span
                        >
                        <% } %>
                      </td>
                      <td><%=item.orderDetails.orderDate.toDateString()%></td>
                      <td>
                        <%=item.userDetails.firstName%>
                        <%=item.userDetails.lastName%>
                      </td>
                      <td>
                        <%item.orderDetails.orderItems.forEach((x)=>{%>
                        <div>
                          <%=x.productName%>
                          ×
                          <%=x.quantity%>

                          <% if(x.return?.returnStatus === 'requested') { %>
                          <span class="badge bg-warning text-dark ms-1"
                            >Return Requested</span
                          >
                          <% } %>
                        </div>
                        <%})%>
                      </td>
                      <td>₹<%=item.orderDetails.orderTotal%></td>
                      <td>
                        <%=item.orderDetails.paymentMethod%>
                        -
                        <%=item.orderDetails.paymentStatus%>
                      </td>

                      <td>
                        <span
                          class="badge <%= item.orderDetails.status === 'delivered' ? 'bg-success' : item.orderDetails.status === 'cancelled' ? 'bg-danger' : item.orderDetails.status === 'returned' ? 'bg-danger' :item.orderDetails.status === 'failed' ? 'bg-danger border border-2 border-black' : 'bg-info text-dark' %>"
                        >
                          <%= item.orderDetails.status %>
                        </span>
                      </td>
                      <td>
                        <button
                          class="btn btn-info"
                          data-bs-toggle="modal"
                          data-bs-target="#orderModal<%=item.orderDetails.orderNumber%>"
                        >
                          View
                        </button>
                      </td>
                    </tr>
                    <%})%>
                  </tbody>
                </table>

                <% orders.forEach((item) => { %>
                <!-- Order Modal -->
                <div
                  class="modal fade"
                  id="orderModal<%=item.orderDetails.orderNumber%>"
                  tabindex="-1"
                >
                  <div class="modal-dialog modal-xl modal-dialog-scrollable">
                    <div class="modal-content border-0 shadow-lg">
                      <!-- Header -->
                      <div class="modal-header bg-white text-dark">
                        <h5 class="modal-title">
                          <i class="bi bi-receipt-cutoff me-2"></i>
                          Order #<%= item.orderDetails.orderNumber %>
                        </h5>
                        <button
                          type="button"
                          class="btn-close btn-close-white"
                          data-bs-dismiss="modal"
                        ></button>
                      </div>

                      <!-- Body -->
                      <div class="modal-body">
                        <!-- Order Info -->
                        <div class="card shadow-sm mb-4">
                          <div class="row g-0">
                            <!-- Left column -->
                            <div class="col-md-6">
                              <div class="card-body">
                                <h6 class="fw-bold mb-3">
                                  <i class="bi bi-info-circle me-1"></i>
                                  Customer Details
                                </h6>
                                <p>
                                  <strong>Name:</strong>
                                  <%= item.userDetails.firstName %>
                                  <%= item.userDetails.lastName %>
                                </p>
                                <p>
                                  <strong>Email:</strong>
                                  <%= item.userDetails.email %>
                                </p>
                                <p>
                                  <strong>Phone No:</strong>
                                  <%= item.userDetails.phoneNo %>
                                </p>
                              </div>
                            </div>

                            <!-- Right column -->
                            <div class="col-md-6 border-start">
                              <div class="card-body">
                                <h6 class="fw-bold mb-3">
                                  <i class="bi bi-geo-alt me-1"></i> Shipping
                                  Address
                                </h6>
                                <p>
                                  <strong>Name:</strong>
                                  <%= item.orderDetails.shippingAddress.name %>
                                </p>
                                <p>
                                  <strong>Phone No.:</strong>
                                  <%= item.orderDetails.shippingAddress.phoneNo %>
                                </p>
                                <p>
                                  <strong>Address:</strong>
                                  <%= item.orderDetails.shippingAddress.addressLine %>
                                </p>

                                <p>
                                  <strong>City:</strong>
                                  <%= item.orderDetails.shippingAddress.townCity %>
                                </p>
                                <p>
                                  <strong>State:</strong>
                                  <%= item.orderDetails.shippingAddress.state %>
                                </p>
                                <p>
                                  <strong>Pincode:</strong>
                                  <%= item.orderDetails.shippingAddress.pincode %>
                                </p>
                                <p>
                                  <strong>Address Type:</strong>
                                  <%= item.orderDetails.shippingAddress.addressType %>
                                </p>
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- Products -->
                        <div class="card shadow-sm mb-4">
                          <div class="card-body">
                            <h6 class="fw-bold mb-3">
                              <i class="bi bi-box-seam me-1"></i> Order Details
                            </h6>

                            <p>
                              <strong>Order Date:</strong>
                              <%= item.orderDetails.orderDate.toDateString() %>
                            </p>

                            <p>
                              <strong>Payment:</strong>
                              <%= item.orderDetails.paymentMethod %>
                              -
                              <span
                                class="badge <%= item.orderDetails.paymentStatus === 'completed' ? 'bg-success' : 'bg-warning text-dark' %>"
                              >
                                <%= item.orderDetails.paymentStatus %>
                              </span>
                            </p>
                            <div class="d-flex justify-content-start mb-3">
                              <p class="me-3">
                                <strong>Order Status:</strong>
                                <span class="badge bg-info text-dark"
                                  ><%= item.orderDetails.status %></span
                                >
                              </p>

                              <form
                                action="/admin/updateOrderStatus?_method=PATCH"
                                method="POST"
                              >
                                <div class="d-flex">
                                  <!-- send orderId -->
                                  <input
                                    type="hidden"
                                    name="orderId"
                                    value="<%= item.orderDetails._id || item.orderDetails[0]?._id %>"
                                  />
                                  <!-- select dropdown -->
                                  <select
                                    name="status"
                                    class="form-select mb-2"
                                    style="width: 300px"
                                  >
                                    <option value="">
                                      Change order status
                                    </option>
                                    <option value="pending">Pending</option>
                                    <option value="confirmed">Confirmed</option>
                                    <option value="shipped">Shipped</option>
                                    <option value="delivered">Delivered</option>
                                    <option value="cancelled">Cancelled</option>
                                    <option value="returned">Returned</option>
                                  </select>

                                  <!-- confirm button -->
                                  <button
                                    type="submit"
                                    class="btn btn-outline-secondary"
                                  >
                                    Confirm
                                  </button>
                                </div>
                              </form>
                            </div>

                            <!-- Order-level Return/Cancel Requests -->
                            <% if(item.orderDetails.return.returnStatus === 'requested'){ %>
                            <div class="card shadow-sm mb-4 border-danger">
                              <div class="card-body">
                                <p>
                                  <a
                                    class="btn btn-outline-danger btn-sm"
                                    data-bs-toggle="collapse"
                                    href="#orderRequest<%= item._id %>"
                                  >
                                    View Order-level Request
                                  </a>
                                </p>
                                <div
                                  class="collapse mt-2"
                                  id="orderRequest<%= item._id %>"
                                >
                                  <form
                                    action="/admin/orderRequest?_method=PATCH"
                                    method="POST"
                                    class="border rounded p-3 bg-light"
                                  >
                                    <!-- Hidden inputs to send essential data -->
                                    <input
                                      type="hidden"
                                      name="orderId"
                                      value="<%= item.orderDetails._id %>"
                                    />
                                    <input
                                      type="hidden"
                                      name="refundAmount"
                                      value="<%= item.orderDetails.orderTotalAfterProductReturn %>"
                                    />

                                    <p>
                                      <strong>Type:</strong>
                                      Order Return
                                    </p>
                                    <p>
                                      <strong>Reason:</strong>
                                      <%= item.orderDetails.return.returnReason %>
                                    </p>
                                    <p>
                                      <strong>Notes:</strong>
                                      <%= item.orderDetails.return.additionalNotes %>
                                    </p>
                                    <p>
                                      <strong>Refund Amount:</strong>
                                      <%=  item.orderDetails.orderTotalAfterProductReturn %>
                                    </p>

                                    <div class="d-flex gap-2 mt-2">
                                      <!-- Approve button -->
                                      <button
                                        type="submit"
                                        name="action"
                                        value="approve"
                                        class="btn btn-success btn-sm"
                                      >
                                        Approve
                                      </button>
                                      <!-- Reject button -->
                                      <button
                                        type="submit"
                                        name="action"
                                        value="reject"
                                        class="btn btn-danger btn-sm"
                                      >
                                        Reject
                                      </button>
                                    </div>
                                  </form>
                                </div>
                              </div>
                            </div>
                            <% } %>

                            <table
                              class="table table-sm table-bordered align-middle text-center"
                            >
                              <thead class="table-dark">
                                <tr>
                                  <th>Product</th>
                                  <th>
                                    Price <br />
                                    (Price at Purchase × Quantity = Total)
                                  </th>
                                  <th>
                                    Final Discounted Price
                                    <br />(if Applied)
                                  </th>
                                  <th>
                                    Coupon Details
                                    <br />
                                    (if Applied)
                                  </th>
                                  <th></th>
                                </tr>
                              </thead>
                              <tbody>
                                <% item.orderDetails.orderItems.forEach((prod,
                                idx) => { %>
                                <tr>
                                  <td>
                                    <img
                                      src="<%=prod.variantDetails.variantImages[0]%>"
                                      alt=""
                                      style="width: 100px; height: 100px"
                                    />
                                    <%= prod.productName %>
                                    <%
                                    if(prod.return.returnStatus ===
                                    'requested') { %>
                                    <br />
                                    <a
                                      class="btn btn-outline-warning btn-sm mt-1"
                                      data-bs-toggle="collapse"
                                      href="#productRequest<%= prod.variantId %>"
                                    >
                                      View Request
                                    </a>
                                    <div
                                      class="collapse mt-2"
                                      id="productRequest<%= prod.variantId %>"
                                    >
                                      <form
                                        action="/admin/productRequest?_method=PATCH"
                                        method="POST"
                                        class="border rounded p-3 bg-light"
                                      >
                                        <!-- Hidden inputs to send essential data -->
                                        <input
                                          type="hidden"
                                          name="orderId"
                                          value="<%= item.orderDetails._id %>"
                                        />
                                        <input
                                          type="hidden"
                                          name="productId"
                                          value="<%= prod.productId %>"
                                        />
                                        <input
                                          type="hidden"
                                          name="variantId"
                                          value="<%= prod.variantId %>"
                                        />
                                        <input
                                          type="hidden"
                                          name="refundAmount"
                                          value="<%= prod.finalDiscountedPrice || prod.total %>"
                                        />

                                        <p>
                                          <strong>Type:</strong>
                                          Order Return
                                        </p>
                                        <p>
                                          <strong>Reason:</strong>
                                          <%= prod.return.returnReason %>
                                        </p>
                                        <p>
                                          <strong>Notes:</strong>
                                          <%= prod.return.additionalNotes %>
                                        </p>
                                        <p>
                                          <strong>Refund Amount:</strong>
                                          <%= prod.return.refundAmount %>
                                        </p>

                                        <textarea
                                          id="notes"
                                          name="notes"
                                          class="form-control"
                                          rows="2"
                                          placeholder="Write notes if any..."
                                        ></textarea>
                                        <div
                                          class="d-flex align-items-center justify-content-center gap-2 mt-2"
                                        >
                                          <!-- Approve button -->
                                          <button
                                            type="submit"
                                            name="action"
                                            value="approve"
                                            class="btn btn-success btn-sm"
                                          >
                                            Approve
                                          </button>
                                          <!-- Reject button -->
                                          <button
                                            type="submit"
                                            name="action"
                                            value="reject"
                                            class="btn btn-danger btn-sm"
                                          >
                                            Reject
                                          </button>
                                        </div>
                                      </form>
                                    </div>
                                    <% } %>
                                  </td>
                                  <td>
                                    ₹<%= prod.price %>
                                    *
                                    <%= prod.quantity %>
                                    = ₹<%= prod.total %>
                                  </td>
                                  <td>
                                    <%if(prod.finalDiscountedPrice){%>
                                    ₹<%= prod.finalDiscountedPrice %>
                                    <%}else{%>
                                    Not applied
                                    <%}%>
                                  </td>
                                  <% if (idx === 0) { %>
                                  <td
                                    rowspan="<%=item.orderDetails.orderItems.length%>"
                                  >
                                    <%if(item.orderDetails.couponApplied.isApplied){%>
                                    <em>Coupon Amount:</em
                                    >₹<%=item.orderDetails.couponApplied.couponAmount%>
                                    <br />
                                    <em>Minimum Purchase Amount:</em
                                    >₹<%=item.orderDetails.couponApplied.minPurchaseAmount%><br />
                                    <em
                                      >Order Total After Deducting Coupon
                                      Amount:</em
                                    >₹<%=item.orderDetails.orderTotal%>

                                    <%}else{%>
                                    Not applied
                                    <%}%>
                                  </td>
                                  <%}%>
                                  <td>
                                    <p class="border border-danger">
                                      <% let status; if
                                      (prod.cancellation.cancelStatus
                                      ==='approved') { status = 'Cancelled'; }
                                      else if (prod.return.returnStatus ===
                                      'approved') { status = 'Returned'; } %>
                                      <%= status %>
                                    </p>
                                  </td>
                                </tr>
                                <% }) %>
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </div>

                      <!-- Footer -->
                      <div class="modal-footer">
                        <button
                          class="btn btn-secondary"
                          data-bs-dismiss="modal"
                        >
                          Close
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                <% }) %>

                <%}else{%>
                <div>
                  <h6>No orders...</h6>
                </div>
                <%}%>
              </div>
            </div>
          </div>
        </div>

        <!-- PAGINATION -->
        <div class="d-flex justify-content-end me-5 mt-5">
          <nav>
            <ul class="pagination">
              <% if (page > 1) { %>
              <li class="page-item">
                <a
                  class="page-link"
                  style="background-color: #1e293b; color: #ffffff"
                  href="?page=<%= page - 1 %>&search=<%= search %>"
                  >Prev</a
                >
              </li>
              <% } %>
              <% for (let i = 1; i <= totalPages; i++) { %>
              <li class="page-item <%= page === i ? 'active' : '' %>">
                <a
                  class="page-link"
                  style="background-color: #1e293b; color: #ffffff"
                  href="?page=<%= i %>&search=<%= search %>"
                  ><%= i %></a
                >
              </li>
              <% } %>
              <% if (page < totalPages) { %>
              <li class="page-item">
                <a
                  class="page-link"
                  style="background-color: #1e293b; color: #ffffff"
                  href="?page=<%= page + 1 %>&search=<%= search %>"
                  >Next</a
                >
              </li>
              <% } %>
            </ul>
          </nav>
        </div>
        <!-- PAGINATION -->
      </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="/js2/orderManagement.js"></script>

    <script>
      const success_msg =
        "<%= success_msg && success_msg.length > 0 ? success_msg[0] : '' %>";
      const error_msg =
        "<%= error_msg && error_msg.length > 0 ? error_msg[0] : '' %>";

      if (success_msg && success_msg.length > 0) {
        Swal.fire({
          icon: 'success',
          title: 'Success',
          text: success_msg,
          confirmButtonColor: '#3085d6',
        });
      }

      if (error_msg && error_msg.length > 0) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: error_msg,
          confirmButtonColor: '#d33',
        });
      }
    </script>
  </body>
</html>
