<!-- /*
* Bootstrap 5
* Template Name: Furni
* Template Author: Untree.co
* Template URI: https://untree.co/
* License: https://creativecommons.org/licenses/by/3.0/
*/ -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="author" content="Untree.co" />
    <link rel="shortcut icon" href="/favicon.png" />

    <meta name="description" content="" />
    <meta name="keywords" content="bootstrap, bootstrap4" />

    <!-- Bootstrap CSS -->
    <link href="/css/bootstrap.min.css" rel="stylesheet" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <!-- Font Awesome (latest stable) -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Cookie&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />

    <!-- Css Styles -->
    <link rel="stylesheet" href="/css3/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="/css3/elegant-icons.css" type="text/css" />
    <link rel="stylesheet" href="/css3/jquery-ui.min.css" type="text/css" />
    <link rel="stylesheet" href="/css3/magnific-popup.css" type="text/css" />
    <link rel="stylesheet" href="/css3/owl.carousel.min.css" type="text/css" />
    <link rel="stylesheet" href="/css3/slicknav.min.css" type="text/css" />
    <link rel="stylesheet" href="/css3/style.css" type="text/css" />

    <link href="/css/tiny-slider.css" rel="stylesheet" />
    <link href="/css/style.css" rel="stylesheet" />
    <link rel="stylesheet" href="/css/tempusStyle.css" />
    <link rel="stylesheet" href="/css/orderStyle.css" />
    <title>Tempus</title>
  </head>

  <body>
    <!--HEADER-->
    <%- include('../../views/partials/user/header')%>
    <!--HEADER-->

    <div class="page-container">
      <!-- Breadcrumb -->
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb breadcrumb-custom">
          <li class="breadcrumb-item"><a href="/dashboard">Your Account</a></li>
          <li class="breadcrumb-item active" aria-current="page">
            Your Orders
          </li>
        </ol>
      </nav>

      <!-- Page Title -->
      <h1 class="page-title">Your Orders</h1>

      <!-- Filter Section -->
      <div class="filter-section">
        <div class="row align-items-center">
          <div class="col-md-6">
            <div class="d-flex align-items-center gap-3">
              <span class="fw-medium">Filter by:</span>
              <select
                class="form-select filter-dropdown"
                onchange="filterOrders(this.value)"
              >
                <option value="all">All orders</option>
                <option value="delivered">Delivered</option>
                <option value="shipped">Shipped</option>
                <option value="processing">Processing</option>
                <option value="cancelled">Cancelled</option>
              </select>
              <select class="form-select filter-dropdown">
                <option>Last 3 months</option>
                <option>Last 6 months</option>
                <option>This year</option>
                <option>All time</option>
              </select>
            </div>
          </div>
          <!-- <div class="col-md-6 text-end">
            <span class="text-muted">5 orders placed</span>
          </div> -->
        </div>
      </div>

      <!-- Orders List -->
      <div id="ordersList">
        <!-- Orders -->
        <%if(orders){%>
        <%orders[0].orderDetails.forEach((item)=>{%>
        <div class="order-card" data-status="delivered">
          <div class="order-header">
            <div class="row">
              <div class="col-md-3">
                <div class="order-info">
                  <strong>ORDER PLACED</strong><br />
                  <%=item.orderDate.toDateString()%>
                </div>
              </div>
              <div class="col-md-2">
                <div class="order-info">
                  <strong>TOTAL</strong><br />
                  â‚¹<%=item.orderTotal%>
                </div>
              </div>
              <div class="col-md-3">
                <div class="order-info">
                  <strong>SHIP TO</strong><br />
                  <%= item.shippingAddress.name %>
                </div>
              </div>
              <div class="col-md-4 text-end">
                <div class="order-info">
                  <strong
                    >ORDER No.
                    <%=item.orderNumber%></strong
                  ><br />
                  <a href="#" class="text-decoration-none"
                    >View order details</a
                  >
                  |
                  <a href="#" class="text-decoration-none">Invoice</a>
                </div>
              </div>
            </div>
          </div>
          <div class="order-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <span class="status-badge status-delivered">
                <%if(item.status=='pending'){%>
                <span class="badge bg-warning text-dark">Pending</span>
                <i class="fas fa-clock text-warning me-1"></i> Expected delivery
                <%=item.deliveryDate.toDateString()%>
                <%}else if(item.status=='shipped'){%>
                <span class="badge bg-primary">Shipped</span>
                <i class="fas fa-shipping-fast text-info me-1"></i> Expected
                delivery
                <%=item.deliveryDate.toDateString()%>
                <%}else if(item.status=='delivered'){%>
                <span class="badge bg-success">Delivered</span>
                <i class="fas fa-check-circle text-success me-1"></i> Delivered
                on
                <%=item.deliveryDate.toDateString()%>
                <%}else if(item.status=='cancelled'){%>
                <span class="badge bg-danger">Cancelled</span>
                <i class="fas fa-ban text-danger me-1"></i> Cancelled
                <%}%>
              </span>
              <div class="order-actions">
                <button
                  class="btn btn-secondary-custom"
                  onclick="trackPackage('112-3456789-1234567')"
                >
                  <i class="fas fa-search me-1"></i>Track package
                </button>

                <!-- Cancel button -->
                <% if (item.cancellation.cancelStatus===null && ['pending','confirmed','shipped'].includes(item.status)) { %>
                <button
                  class="btn btn-secondary-custom"
                  data-bs-toggle="modal"
                  data-bs-target="#cancelOrderModal-<%=item.orderNumber%>"
                >
                  <i class="fas fa-undo me-1"></i> Cancel Items
                </button>

                <% } else if (item.cancellation.cancelStatus === 'requested') { %>
                <button class="btn btn-secondary-custom" disabled>
                  <i class="fas fa-undo me-1"></i> Requested for cancellation
                </button>

                <% } else if (item.cancellation.cancelStatus === 'approved') { %>
                <span class="badge bg-success"> Cancelled (Approved) </span>

                <% } else if (item.cancellation.cancelStatus === 'rejected') { %>
                <span class="badge bg-warning text-dark">
                  Cancellation Rejected
                </span>

                <% } %>

                <!-- Return button -->
                <% if (item.status === 'delivered' && !item.return.isReturned) { %>
                <button
                  class="btn btn-secondary-custom"
                  data-bs-toggle="modal"
                  data-bs-target="#returnOrderModal-<%=item.orderNumber%>"
                >
                  <i class="bi bi-reply me-1"></i> Return Items
                </button>
                <% } else if (item.return.isReturned) { %>
                <span class="badge bg-secondary">
                  Returned (<%= item.return.returnStatus %>)
                </span>
                <% } %>

                <!-- ================= ORDER-LEVEL CANCEL MODAL ================= -->
                <div
                  class="modal fade"
                  id="cancelOrderModal-<%=item.orderNumber%>"
                  tabindex="-1"
                  aria-hidden="true"
                >
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                      <form method="post" action="/orders/cancelOrder">
                        <input
                          type="hidden"
                          name="orderId"
                          value="<%= item._id %>"
                        />
                        <input
                          type="hidden"
                          name="orderNumber"
                          value="<%= item.orderNumber %>"
                        />
                        <input
                          type="hidden"
                          name="refundAmount"
                          value="<%= item.subTotal %>"
                        />
                        <div class="modal-header">
                          <h5 class="modal-title">Cancel Order</h5>
                          <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                          ></button>
                        </div>
                        <div class="modal-body">
                          <div class="mb-3">
                            <label class="form-label"
                              >Reason for cancellation</label
                            >
                            <select
                              class="form-select"
                              name="cancelReason"
                              required
                            >
                              <option value="">Select a reason</option>
                              <option>Changed my mind</option>
                              <option>Found a better price</option>
                              <option>Ordered by mistake</option>
                              <option>Other</option>
                            </select>
                          </div>
                          <div class="mb-3">
                            <label class="form-label"
                              >Additional notes (optional)</label
                            >
                            <textarea
                              class="form-control"
                              name="additionalNotes"
                              rows="3"
                            ></textarea>
                          </div>
                        </div>
                        <div class="modal-footer">
                          <button
                            type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal"
                          >
                            Cancel
                          </button>
                          <button type="submit" class="btn btn-danger">
                            Submit Cancellation
                          </button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>

                <!-- ================= ORDER-LEVEL RETURN MODAL ================= -->
                <div
                  class="modal fade"
                  id="returnOrderModal-<%=item.orderNumber%>"
                  tabindex="-1"
                  aria-hidden="true"
                >
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                      <form method="post" action="/orders/returnOrder">
                        <input
                          type="hidden"
                          name="orderId"
                          value="<%= item._id %>"
                        />
                        <div class="modal-header">
                          <h5 class="modal-title">Return Order</h5>
                          <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                          ></button>
                        </div>
                        <div class="modal-body">
                          <div class="mb-3">
                            <label class="form-label">Reason for return</label>
                            <select
                              class="form-select"
                              name="returnReason"
                              required
                            >
                              <option value="">Select a reason</option>
                              <option>Received wrong item</option>
                              <option>Damaged or defective</option>
                              <option>Not as described</option>
                              <option>Other</option>
                            </select>
                          </div>
                          <div class="mb-3">
                            <label class="form-label"
                              >Additional notes (optional)</label
                            >
                            <textarea
                              class="form-control"
                              name="additionalNotes"
                              rows="3"
                            ></textarea>
                          </div>
                        </div>
                        <div class="modal-footer">
                          <button
                            type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal"
                          >
                            Cancel
                          </button>
                          <button type="submit" class="btn btn-warning">
                            Submit Return
                          </button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <%item.orderItems.forEach((product)=>{%>
            <div class="product-row">
              <!-- <div class="product-image">
                <i class="fas fa-headphones text-muted fs-3"></i>
              </div> -->
              <img
                src="<%=product.variantDetails.variantImages[0]%>"
                alt=""
                class="img-fluid me-5"
                style="width: 200px; height: 200px"
              />
              <div class="product-details">
                <a href="#" class="product-title d-block"
                  ><%=product.productName%></a
                >
                <div class="product-meta">
                  Brand: <%=product.brand%> | Quantity: <%=product.quantity%>
                </div>
                <div class="mt-2">
                  <button
                    class="btn btn-primary-custom me-2"
                    onclick="buyAgain('headphones')"
                  >
                    <i class="fas fa-shopping-cart me-1"></i>Buy it again
                  </button>
                  <button
                    class="btn btn-secondary-custom"
                    data-bs-toggle="modal"
                    data-bs-target="#reviewModal"
                  >
                    <i class="fas fa-star me-1"></i>Write a product review
                  </button>

                  <!-- Write Review Modal -->
                  <div
                    class="modal fade"
                    id="reviewModal"
                    tabindex="-1"
                    aria-hidden="true"
                  >
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                      <div class="modal-content">
                        <form id="reviewForm">
                          <div class="modal-header">
                            <h5 class="modal-title">Write a Review</h5>
                            <button
                              type="button"
                              class="btn-close"
                              data-bs-dismiss="modal"
                            ></button>
                          </div>
                          <div class="modal-body">
                            <!-- Rating Stars -->
                            <div class="mb-3">
                              <label class="form-label">Your Rating</label>
                              <div class="star-rating">
                                <i class="bi bi-star fs-3" data-value="1"></i>
                                <i class="bi bi-star fs-3" data-value="2"></i>
                                <i class="bi bi-star fs-3" data-value="3"></i>
                                <i class="bi bi-star fs-3" data-value="4"></i>
                                <i class="bi bi-star fs-3" data-value="5"></i>
                              </div>
                              <input
                                type="hidden"
                                name="rating"
                                id="ratingValue"
                                required
                              />
                            </div>

                            <!-- Review Text -->
                            <div class="mb-3">
                              <label for="reviewText" class="form-label"
                                >Your Review</label
                              >
                              <textarea
                                class="form-control"
                                id="reviewText"
                                rows="4"
                                required
                              ></textarea>
                            </div>

                            <!-- Upload Image -->
                            <div class="mb-3">
                              <label for="reviewImage" class="form-label"
                                >Upload Image (optional)</label
                              >
                              <input
                                class="form-control"
                                type="file"
                                id="reviewImage"
                                accept="image/*"
                              />
                            </div>
                          </div>
                          <div class="modal-footer">
                            <button
                              type="button"
                              class="btn btn-secondary"
                              data-bs-dismiss="modal"
                            >
                              Cancel
                            </button>
                            <button type="submit" class="btn btn-primary">
                              Submit Review
                            </button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>

                  <!-- Write Review Modal -->

                  <!-- Cancel flow -->
                  <% if (!product.cancellation.cancelStatus && ['pending','confirmed','shipped'].includes(item.status)) { %>
                  <button
                    class="btn btn-secondary-custom"
                    data-bs-toggle="modal"
                    data-bs-target="#cancelItemModal-<%=product._id%>"
                  >
                    <i class="bi bi-reply me-1"></i> Cancel Item
                  </button>

                  <% } else if (product.cancellation.cancelStatus === 'requested') { %>
                  <button
                    class="btn btn-secondary-custom"
                    style="display: none"
                  >
                    <i class="bi bi-reply me-1"></i> Requested for cancellation
                  </button>

                  <% } else if (product.cancellation.cancelStatus === 'approved') { %>
                  <span class="badge bg-success"> Cancelled (Approved) </span>

                  <% } else if (product.cancellation.cancelStatus === 'rejected') { %>
                  <span class="badge bg-warning text-dark">
                    Cancellation Rejected
                  </span>
                  <% } %>

                  <!-- Return flow -->
                  <% if (item.status === 'delivered' && !product.return.isReturned && !product.cancellation.isCancelled) { %>
                  <button
                    class="btn btn-secondary-custom"
                    data-bs-toggle="modal"
                    data-bs-target="#returnItemModal-<%=product._id%>"
                  >
                    <i class="bi bi-reply me-1"></i> Return Item
                  </button>
                  <% } else if (product.return.isReturned) { %>
                  <span class="badge bg-secondary">
                    Returned (<%= product.return.returnStatus %>)
                  </span>
                  <% } %>

                  <!-- ================= ITEM-LEVEL CANCEL & RETURN MODALS ================= -->
                  <!-- Cancel Item Modal -->
                  <div
                    class="modal fade"
                    id="cancelItemModal-<%=product._id%>"
                    tabindex="-1"
                    aria-hidden="true"
                  >
                    <div class="modal-dialog modal-dialog-centered">
                      <div class="modal-content">
                        <form method="post" action="/orders/cancelItem">
                          <input
                            type="hidden"
                            name="orderId"
                            value="<%= item._id %>"
                          />
                          <input
                            type="hidden"
                            name="orderNumber"
                            value="<%= item.orderNumber %>"
                          />
                          <input
                            type="hidden"
                            name="productId"
                            value="<%= product.productId %>"
                          />
                          <input
                            type="hidden"
                            name="variantId"
                            value="<%= product.variantId %>"
                          />

                          <div class="modal-header">
                            <h5 class="modal-title">Cancel Item</h5>
                            <button
                              type="button"
                              class="btn-close"
                              data-bs-dismiss="modal"
                            ></button>
                          </div>
                          <div class="modal-body">
                            <div class="mb-3">
                              <label class="form-label"
                                >Reason for cancellation</label
                              >
                              <select
                                class="form-select"
                                name="cancelReason"
                                required
                              >
                                <option value="">Select a reason</option>
                                <option>Changed my mind</option>
                                <option>Found a better price</option>
                                <option>Ordered by mistake</option>
                                <option>Other</option>
                              </select>
                            </div>
                            <div class="mb-3">
                              <label class="form-label"
                                >Additional notes (optional)</label
                              >
                              <textarea
                                class="form-control"
                                name="additionalNotes"
                                rows="3"
                              ></textarea>
                            </div>
                          </div>
                          <div class="modal-footer">
                            <button
                              type="button"
                              class="btn btn-secondary"
                              data-bs-dismiss="modal"
                            >
                              Cancel
                            </button>
                            <button type="submit" class="btn btn-danger">
                              Submit Cancellation
                            </button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>

                  <!-- Return Item Modal -->
                  <div
                    class="modal fade"
                    id="returnItemModal-<%=product._id%>"
                    tabindex="-1"
                    aria-hidden="true"
                  >
                    <div class="modal-dialog modal-dialog-centered">
                      <div class="modal-content">
                        <form method="post" action="/orders/returnItem">
                          <input
                            type="hidden"
                            name="orderId"
                            value="<%= item._id %>"
                          />
                          <input
                            type="hidden"
                            name="itemId"
                            value="<%= product._id %>"
                          />
                          <div class="modal-header">
                            <h5 class="modal-title">Return Item</h5>
                            <button
                              type="button"
                              class="btn-close"
                              data-bs-dismiss="modal"
                            ></button>
                          </div>
                          <div class="modal-body">
                            <div class="mb-3">
                              <label class="form-label"
                                >Reason for return</label
                              >
                              <select
                                class="form-select"
                                name="returnReason"
                                required
                              >
                                <option value="">Select a reason</option>
                                <option>Received wrong item</option>
                                <option>Damaged or defective</option>
                                <option>Not as described</option>
                                <option>Other</option>
                              </select>
                            </div>
                            <div class="mb-3">
                              <label class="form-label"
                                >Additional notes (optional)</label
                              >
                              <textarea
                                class="form-control"
                                name="additionalNotes"
                                rows="3"
                              ></textarea>
                            </div>
                          </div>
                          <div class="modal-footer">
                            <button
                              type="button"
                              class="btn btn-secondary"
                              data-bs-dismiss="modal"
                            >
                              Cancel
                            </button>
                            <button type="submit" class="btn btn-warning">
                              Submit Return
                            </button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <%})%>
          </div>
        </div>
        <%})%>
        <%}else{%>
        <div>
          <h6>No orders to show</h6>
        </div>
        <%}%>
      </div>

      <!-- Pagination -->
      <nav aria-label="Orders pagination" class="pagination-custom">
        <ul class="pagination justify-content-center">
          <li class="page-item disabled">
            <a class="page-link" href="#" tabindex="-1">Previous</a>
          </li>
          <li class="page-item active">
            <a class="page-link" href="#">1</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="#">2</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="#">3</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="#">Next</a>
          </li>
        </ul>
      </nav>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      (function () {
        function c() {
          var b = a.contentDocument || a.contentWindow.document;
          if (b) {
            var d = b.createElement('script');
            d.innerHTML =
              "window.__CF$cv$params={r:'97ccf5c495e947f1',t:'MTc1NzQ4NjcwMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";
            b.getElementsByTagName('head')[0].appendChild(d);
          }
        }
        if (document.body) {
          var a = document.createElement('iframe');
          a.height = 1;
          a.width = 1;
          a.style.position = 'absolute';
          a.style.top = 0;
          a.style.left = 0;
          a.style.border = 'none';
          a.style.visibility = 'hidden';
          document.body.appendChild(a);
          if ('loading' !== document.readyState) c();
          else if (window.addEventListener)
            document.addEventListener('DOMContentLoaded', c);
          else {
            var e = document.onreadystatechange || function () {};
            document.onreadystatechange = function (b) {
              e(b);
              'loading' !== document.readyState &&
                ((document.onreadystatechange = e), c());
            };
          }
        }
      })();
    </script>

    <!--FOOTER-->
    <%- include('../../views/partials/user/footer')%>
    <!--FOOTER-->
    <!-- Js Plugins -->
    <script src="/js3/jquery-3.3.1.min.js"></script>
    <script src="/js3/bootstrap.min.js"></script>
    <script src="/js3/jquery.magnific-popup.min.js"></script>
    <script src="/js3/jquery-ui.min.js"></script>
    <script src="/js3/mixitup.min.js"></script>
    <script src="/js3/jquery.countdown.min.js"></script>
    <script src="/js3/jquery.slicknav.js"></script>
    <script src="/js3/owl.carousel.min.js"></script>
    <script src="/js3/jquery.nicescroll.min.js"></script>
    <script src="/js3/main.js"></script>
    <script src="/js/bootstrap.bundle.min.js"></script>
    <script src="/js/tiny-slider.js"></script>
    <script src="/js/custom.js"></script>
    <script src="/js/templateJS.js"></script>
    <script src="/js/orders.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
      const success_msg =
        "<%= success_msg && success_msg.length > 0 ? success_msg[0] : '' %>";
      const error_msg =
        "<%= error_msg && error_msg.length > 0 ? error_msg[0] : '' %>";

      if (success_msg && success_msg.length > 0) {
        Swal.fire({
          icon: 'success',
          title: 'Success',
          text: success_msg,
          confirmButtonColor: '#3085d6',
        });
      }

      if (error_msg && error_msg.length > 0) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: error_msg,
          confirmButtonColor: '#d33',
        });
      }
    </script>
  </body>
</html>
